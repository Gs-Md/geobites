import React, { useEffect, useRef, useState } from "react";
import "../styles/AuthModal.css";
import { signup, login } from "../services/authService";


const initial = { email: "", password: "", name: "", confirm: "" };

const AuthModal = ({ onClose, onLoginSuccess }) => {
  const [activeTab, setActiveTab] = useState("login");
  const [formData, setFormData] = useState(initial);
  const [error, setError] = useState("");
  const modalRef = useRef(null);

  useEffect(() => {
    const { body } = document;
    const prev = body.style.overflow;
    body.style.overflow = "hidden";
    return () => (body.style.overflow = prev);
  }, []);

  useEffect(() => {
    const onKey = (e) => e.key === "Escape" && onClose();
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [onClose]);

  const onOverlayClick = (e) => {
    if (modalRef.current && !modalRef.current.contains(e.target)) onClose();
  };

  const onChange = (e) =>
    setFormData((s) => ({ ...s, [e.target.name]: e.target.value }));

  const validate = () => {
    setError("");
    const { email, password, name, confirm } = formData;
    const emailOK = /^\S+@\S+\.\S+$/.test(email);
    if (!emailOK) return "Please enter a valid email address.";
    if (!password || password.length < 6)
      return "Password must be at least 6 characters.";
    if (activeTab === "signup") {
      if (!name || name.trim().length === 0) return "Please enter your name.";
      if (password !== confirm) return "Passwords do not match.";
    }
    return "";
  };

  const onSubmit = async (e) => {
    e.preventDefault();
    setError("");
    // basic validations
    if (activeTab === "signup") {
      if (formData.password !== formData.confirm) {
        return setError("Passwords do not match");
      }
      if (!formData.name) return setError("Please enter your name");
      try {
        const user = await signup({
          name: formData.name,
          email: formData.email,
          password: formData.password,
        });
        onLoginSuccess && onLoginSuccess(user);
        onClose();
      } catch (err) {
        setError(err.message);
      }
      return;
    }

    // login flow
    try {
      const user = await login({
        email: formData.email,
        password: formData.password,
      });
      onLoginSuccess && onLoginSuccess(user);
      onClose();
    } catch (err) {
      setError(err.message);
    }
  };

  const switchTab = (t) => {
    setActiveTab(t);
    setFormData(initial);
    setError("");
  };

  return (
    <div
      className="auth-overlay"
      onMouseDown={onOverlayClick}
      aria-modal="true"
      role="dialog"
    >
      <div
        className="auth-modal"
        ref={modalRef}
        onMouseDown={(e) => e.stopPropagation()}
      >
        <button
          className="close-btn"
          type="button"
          onClick={onClose}
          aria-label="Close"
        >
          √ó
        </button>

        <div className="tabs" role="tablist" aria-label="Authentication tabs">
          <button
            role="tab"
            aria-selected={activeTab === "login"}
            className={activeTab === "login" ? "active" : ""}
            onClick={() => switchTab("login")}
            type="button"
          >
            Login
          </button>
          <button
            role="tab"
            aria-selected={activeTab === "signup"}
            className={activeTab === "signup" ? "active" : ""}
            onClick={() => switchTab("signup")}
            type="button"
            
          >
            Sign Up
          </button>
        </div>

        <form onSubmit={onSubmit} noValidate>
          {activeTab === "signup" && (
            <input
              type="text"
              name="name"
              placeholder="Full name"
              value={formData.name}
              onChange={onChange}
              required
            />
          )}

          <input
            type="email"
            name="email"
            placeholder="Email"
            value={formData.email}
            onChange={onChange}
            autoComplete="email"
            required
          />

          <input
            type="password"
            name="password"
            placeholder="Password"
            value={formData.password}
            onChange={onChange}
            autoComplete={activeTab === "signup" ? "new-password" : "current-password"}
            required
          />

          {activeTab === "signup" && (
            <input
              type="password"
              name="confirm"
              placeholder="Confirm password"
              value={formData.confirm}
              onChange={onChange}
              autoComplete="new-password"
              required
            />
          )}

          {error && (
            <p className="error" role="alert">
              {error}
            </p>
          )}
          <button type="submit" className="submit-btn">
            {activeTab === "signup" ? "Sign Up" : "Log In"}
          </button>
          {activeTab === "login" && (
            <button
              type="button"
              className="link-btn"
              onClick={() =>
                alert("Forgot password flow not implemented in this demo")
              }
            >
              Forgot password?
            </button>
          )}
        </form>
      </div>
    </div>
  );
};

export default AuthModal;

import React, { useState } from "react";
import "../styles/CheckoutModal.css";

const CheckoutModal = ({ cart = [], subtotal = 0, currentUser, onClose, onPlaced }) => {
  const [name, setName] = useState(currentUser?.name || "");
  const [address, setAddress] = useState("");
  const [note, setNote] = useState("");
  const [loading, setLoading] = useState(false);
  const fee = 3;
  const total = subtotal + fee;

  const placeOrder = async () => {
    if (!name || !address) return alert("Please enter name and address");
    setLoading(true);
    try {
      const res = await fetch("/api/orders", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, address: `${address}${note ? ' ‚Äî '+note : ''}`, items: cart, subtotal, fee, total }),
      });
      const d = await res.json();
      if (!res.ok) throw new Error(d.message || "Order failed");
      // clear server cart and notify parent
      await fetch("/api/cart", { method: "POST", credentials: "include", headers: { "Content-Type": "application/json" }, body: JSON.stringify([]) });
      onPlaced && onPlaced(d.orderId);
    } catch (e) {
      alert(e.message || "Failed to place order");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="checkout-overlay" onMouseDown={onClose}>
      <div className="checkout-modal" onMouseDown={(e) => e.stopPropagation()}>
        <button className="close-btn" onClick={onClose}>√ó</button>
        <h2>Checkout</h2>
        <div className="checkout-summary">
          <div className="items-list">
            {cart.map((it) => (
              <div key={it.id} className="item-row">
                <span>{it.name} √ó {it.qty}</span>
                <span>${(it.price * it.qty).toFixed(2)}</span>
              </div>
            ))}
          </div>
          <div className="totals">
            <div><span>Subtotal</span><span>${subtotal.toFixed(2)}</span></div>
            <div><span>Delivery</span><span>${fee.toFixed(2)}</span></div>
            <div className="total-row"><strong>Total</strong><strong>${total.toFixed(2)}</strong></div>
          </div>
        </div>

        <div className="checkout-form">
          <label>Name</label>
          <input value={name} onChange={(e) => setName(e.target.value)} />
          <label>Address</label>
          <textarea value={address} onChange={(e) => setAddress(e.target.value)} />
          <label>Note (optional)</label>
          <input value={note} onChange={(e) => setNote(e.target.value)} />
        </div>

        <div className="checkout-actions">
          <button className="secondary" onClick={onClose} disabled={loading}>Cancel</button>
          <button className="primary" onClick={placeOrder} disabled={loading}>{loading ? 'Placing...' : 'Place Order'}</button>
        </div>
        <p className="demo-note">This is a demo checkout. No real payment is collected.</p>
      </div>
    </div>
  );
};

export default CheckoutModal;

import React from 'react'
import InstagramIcon from "@mui/icons-material/Instagram";
import TwitterIcon from "@mui/icons-material/Twitter";
import FacebookIcon from "@mui/icons-material/Facebook";
import LinkedInIcon from "@mui/icons-material/LinkedIn";
import "../styles/Footer.css";
 const Footer = () => { return (
<div className="footer">
<div className="socialMedia">
<InstagramIcon /> <TwitterIcon /> <FacebookIcon /> <LinkedInIcon />
</div>
<p> &copy; 2025 Lebanese International University </p> </div>
) }
export default Footer
import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import logo from "../assets/pic5.jpg";
import "../styles/Navbar.css";
import AuthModal from "../components/AuthModal";
import ShoppingCartIcon from "@mui/icons-material/ShoppingCart";

const Navbar = ({ cartCount = 0, isLoggedIn, setIsLoggedIn, isOwner, setIsOwner, onLoginSuccess, onLogout, currentUser }) => {
  const [showAuth, setShowAuth] = useState(false);
  const navigate = useNavigate();

  const openAuth = () => setShowAuth(true);
  const closeAuth = () => setShowAuth(false);

  const handleAuthClick = async () => {
    if (isLoggedIn) {
      // prefer caller-provided logout handler (App), otherwise call demo server endpoint
      if (onLogout) {
        onLogout();
      } else {
        try {
          const API_BASE = process.env.REACT_APP_API_BASE || "";
          await fetch(`${API_BASE}/api/auth/logout`, {
            method: "POST",
            credentials: "include",
          });
        } catch (e) {
          // ignore network errors in demo
        }
        setIsLoggedIn(false);
        setIsOwner(false);
      }
      navigate("/");
    } else {
      openAuth();
    }
  };

  return (
    <>
      <div className="navbar">
        <nav className="navlinks">
          <Link to="/">
            <img className="logo" src={logo} alt="GeoBites logo" />
          </Link>

          <Link to="/">Home</Link>
          <Link to="/about">About</Link>
          <Link to="/menu">Menu</Link>
          <Link to="/order">Order</Link>

          {!isOwner && <Link to="/Contact">Contact</Link>}

          {isOwner && <Link to="/Inbox">Messages</Link>}

          {currentUser && (
            <span className="user-greeting">Hi, {currentUser.name}</span>
          )}

          <Link to="/order" className="cart-btn">
            <ShoppingCartIcon className="cart-icon" />
            {cartCount > 0 && <span className="cart-badge">{cartCount}</span>}
          </Link>

          <button className="authtoggleBtn" onClick={handleAuthClick}>
            {isLoggedIn ? "Logout" : "Login / Signup"}
          </button>
        </nav>
      </div>

      {showAuth && (
        <AuthModal
          onClose={closeAuth}
          onLoginSuccess={(user) => {
            if (onLoginSuccess) {
              onLoginSuccess(user);
            } else {
              // After login, App will set flags via /auth/me, but set now for snappier UI:
              setIsLoggedIn(true);
              setIsOwner(true);
            }
            closeAuth();
          }}
        />
      )}
    </>
  );
};

export default Navbar;
const MenuData = {
  Appetizers: [
    {
      id: "a1",
      name: "Cheese Sticks",
      price: 5,
      img: require("../assets/cheese sticks.jpg"),
    },
    {
      id: "a2",
      name: "Garlic Bread",
      price: 4,
      img: require("../assets/garlic bread.jpg"),
    },
  ],
  Desserts: [
    {
      id: "d1",
      name: "Brownie",
      price: 6,
      img: require("../assets/brownie.jpg"),
    },
    {
      id: "d2",
      name: "Ice Cream",
      price: 3,
      img: require("../assets/icecream.jpg"),
    },
  ],
  Sandwiches: [
    {
      id: "s1",
      name: "Francisco",
      price: 7,
      img: require("../assets/francisco.jpg"),
    },
    {
      id: "s2",
      name: "Fajita",
      price: 6,
      img: require("../assets/fajita.jpg"),
    },
  ],
  Burgers: [
    {
      id: "b1",
      name: "Classic Burger",
      price: 8,
      img: require("../assets/classic.jpg"),
    },
    {
      id: "b2",
      name: "Zinger",
      price: 9,
      img: require("../assets/zinger.jpg"),
    },
  ],
  Pizzas: [
    {
      id: "p1",
      name: "Sweet & Sour Chicken",
      price: 10,
      img: require("../assets/sweet & sour chicken.jpg"),
    },
    {
      id: "p2",
      name: "Pepperoni",
      price: 11,
      img: require("../assets/pepperoni.jpg"),
    },
  ],
  Drinks: [
    {
      id: "dr1",
      name: "Coca-Cola",
      price: 2,
      img: require("../assets/cocacola.jpg"),
    },
    {
      id: "dr2",
      name: "Orange Juice",
      price: 3,
      img: require("../assets/orangejuice.jpg"),
    },
  ],
};

export default MenuData;
import React from 'react';
import '../styles/About.css';

const About = () => {
  return (
    <div className="about">
      <div className="about-overlay">

        <h1>About GeoBites</h1>
        <p>
          At <strong>GeoBites</strong>, we believe great food brings people together.
          From our handcrafted burgers to our freshly baked pizzas and snacks,
          everything is made with love, passion, and the freshest ingredients.
          <br /><br />
          Whether you‚Äôre dining in or ordering online, GeoBites is here to deliver
          the taste you crave ‚Äî fast, fresh, and unforgettable.
        </p>
      </div>
    </div>
  );
};

export default About;
import React, { useState } from "react";
import "../styles/Contact.css";
import { API_BASE } from "../services/authService";

const Contact = () => {
  const [form, setForm] = useState({
    name: "",
    subject: "",
    email: "",
    description: "",
  });
  const [status, setStatus] = useState("");

  const onChange = (e) =>
    setForm((s) => ({ ...s, [e.target.name]: e.target.value }));

  const onSubmit = async (e) => {
    e.preventDefault();
    setStatus("");
    try {
      const res = await fetch(`${API_BASE}/api/contact`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(form),
      });
      if (!res.ok) throw new Error("Failed to send. Please try again.");
      setStatus("‚úÖ Message sent! We‚Äôll get back to you soon.");
      setForm({ name: "", subject: "", email: "", description: "" });
    } catch (err) {
      setStatus("‚ùå " + err.message);
    }
  };

  return (
    <div className="contact">
      <form className="form" onSubmit={onSubmit}>
        <div className="firstline">
          <h1>WE'RE ALL EARS</h1>
        </div>
        <div className="secondline">
          <input
            type="text"
            name="name"
            placeholder="NAME"
            value={form.name}
            onChange={onChange}
          />
          <input
            type="text"
            name="subject"
            placeholder="SUBJECT"
            value={form.subject}
            onChange={onChange}
          />
        </div>
        <div className="thirdline">
          <input
            type="email"
            name="email"
            placeholder="EMAIL"
            value={form.email}
            onChange={onChange}
          />
        </div>
        <div className="fourthline">
          <textarea
            name="description"
            placeholder="WHATS ON YOUR MIND?"
            rows="5"
            cols="30"
            value={form.description}
            onChange={onChange}
          ></textarea>
        </div>
        <div className="fifthline">
          <button type="submit">SEND</button>
        </div>
        {status && <p style={{ marginTop: 12, fontWeight: 600 }}>{status}</p>}
        <div className="sixthline">
          <p>
            YOU CAN ALSO EMAIL:
            <br />
            CONTACT@EMAIL.COM OR CALL <br />
            US ON: 03/100200
          </p>
        </div>
      </form>
    </div>
  );
};

export default Contact;
import React from "react";
import "../styles/Home.css";
import pic1 from "../assets/pic3.JPG";

const Home = () => {
  return (
    <div className="home">
      <section
        className="home-top"
        style={{ backgroundImage: `url(${pic1})` }}
      >
        <div className="overlay">
          <h1>Welcome to GeoBites</h1>
          <p>Snacks, burgers, pizza - fresh, fast, delivered</p>
          <a href="/menu" className="btn">
            View Menu
          </a>
        </div>
      </section>

      <section className="home-bottom">
        <h2>Our Promise</h2>
        <p>
          At GeoBites, we serve tasty meals made from fresh ingredients ‚Äî
          perfect for any craving.
        </p>
      </section>
    </div>
  );
};

export default Home;
import React, { useEffect, useState } from "react";
import "../styles/Inbox.css";
import { API_BASE } from "../services/authService";

const Inbox = () => {
  const [messages, setMessages] = useState(null);
  const [error, setError] = useState("");

  const loadMessages = () => {
    fetch(`${API_BASE}/api/contact`, { credentials: "include" })
      .then(async (r) => {
        if (!r.ok) {
          const d = await r.json().catch(() => ({}));
          throw new Error(d.message || "Unauthorized");
        }
        return r.json();
      })
      .then(setMessages)
      .catch((err) => {
        setError(err.message);
        setMessages([]);
      });
  };

  useEffect(() => {
    loadMessages();
  }, []);

  const deleteMessage = async (id) => {
    if (!window.confirm("Delete this message?")) return;
    try {
      const res = await fetch(`${API_BASE}/api/contact/${id}`, {
        method: "DELETE",
        credentials: "include",
      });
      if (!res.ok) throw new Error("Failed to delete");
      setMessages((prev) => prev.filter((m) => m.id !== id));
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  if (error) {
    return (
      <div className="inbox">
        <h1>Messages</h1>
        <p className="inbox-error">
          ‚ö† {error}. Log in as owner to view messages.
        </p>
      </div>
    );
  }

  if (!messages) {
    return (
      <div className="inbox">
        <h1>Messages</h1>
        <p>Loading‚Ä¶</p>
      </div>
    );
  }

  return (
    <div className="inbox">
      <h1>Messages</h1>
      {messages.length === 0 ? (
        <p>No messages yet.</p>
      ) : (
        <div className="inbox-list">
          {messages.map((m) => (
            <div key={m.id} className="inbox-card">
              <button
                className="delete-btn"
                onClick={() => deleteMessage(m.id)}
                title="Delete message"
              >
                √ó
              </button>

              <div className="inbox-top">
                <div>
                  <strong>{m.name || "Anonymous"}</strong> ¬∑{" "}
                  {m.email || "No email"}
                </div>
                <div className="inbox-date">
                  {m.createdAt
                    ? new Date(m.createdAt).toLocaleString()
                    : "No date"}
                </div>
              </div>

              <div className="inbox-subject">
                {m.subject || "(No subject)"}
              </div>

              <div className="inbox-body">
                {m.description || "(No message)"}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default Inbox;
import React, { useState } from "react";
import "../styles/Menu.css";
import menuData from "../data/MenuData";

const categories = [
  "Appetizers",
  "Desserts",
  "Sandwiches",
  "Burgers",
  "Pizzas",
  "Drinks",
];

const Menu = ({ onAddToCart, isLoggedIn }) => {
  const [selected, setSelected] = useState("Appetizers");

  return (
    <div className="menu-page">
      <h1 className="menu-title">Our Menu</h1>

      {/* Category slider */}
      <div className="menu-slider">
        {categories.map((cat) => (
          <button
            key={cat}
            className={`menu-category-btn ${selected === cat ? "active" : ""}`}
            onClick={() => setSelected(cat)}
          >
            {cat}
          </button>
        ))}
      </div>

      {/* Item cards */}
      <div className="menu-items">
        {menuData[selected].map((item) => (
          <div className="menu-item-card" key={item.id}>
            <img src={item.img} alt={item.name} />
            <h3>{item.name}</h3>
            <p>${item.price}</p>

            {isLoggedIn ? (
              <button onClick={() => onAddToCart(item)}>Add to Cart</button>
            ) : (
              <p className="login-warning">Login to order</p>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};

export default Menu;

import React, { useState } from "react";
import "../styles/Order.css";
import CheckoutModal from "../components/CheckoutModal";

const Order = ({ cart, incQty, decQty, removeItem, currentUser, onClearCart }) => {
  const [showCheckout, setShowCheckout] = useState(false);
  const [placedId, setPlacedId] = useState(null);
  const subtotal = cart.reduce((sum, it) => sum + it.price * it.qty, 0);

  return (
    <div className="order-background">
      <div className="order-page">
        <h1 className="order-title">üõí Your Order</h1>

        {placedId && (
          <p className="order-confirm">Order placed! ID: {placedId}</p>
        )}

        {cart.length === 0 ? (
          <p className="empty-cart">
            Your cart is empty. Go to the menu and add some items!
          </p>
        ) : (
          <>
            <div className="cart-list">
              {cart.map((it) => (
                <div className="cart-card" key={it.id}>
                  <img src={it.img} alt={it.name} />
                  <div className="cart-info">
                    <h3>{it.name}</h3>
                    <p className="price">${it.price}</p>
                  </div>

                  <div className="cart-qty">
                    <button onClick={() => decQty(it.id)}>-</button>
                    <span>{it.qty}</span>
                    <button onClick={() => incQty(it.id)}>+</button>
                  </div>

                  <div className="line-total">
                    ${(it.price * it.qty).toFixed(2)}
                  </div>

                  <button
                    className="remove-btn"
                    onClick={() => removeItem(it.id)}
                  >
                    √ó
                  </button>
                </div>
              ))}
            </div>

            <div className="order-summary">
              <div className="summary-left">
                <p>Subtotal</p>
                <p>Delivery Fee</p>
                <p className="total-text">Total</p>
              </div>

              <div className="summary-right">
                <p>${subtotal.toFixed(2)}</p>
                <p>$3.00</p>
                <p className="total-text">${(subtotal + 3).toFixed(2)}</p>
              </div>
            </div>

            <button
              className="checkout-btn"
              onClick={() => setShowCheckout(true)}
            >
              Proceed to Checkout
            </button>
          </>
        )}

        {showCheckout && (
          <CheckoutModal
            cart={cart}
            subtotal={subtotal}
            currentUser={currentUser}
            onClose={() => setShowCheckout(false)}
            onPlaced={(orderId) => {
              setPlacedId(orderId);
              setShowCheckout(false);
              // clear cart locally
              onClearCart && onClearCart();
            }}
          />
        )}
      </div>
    </div>
  );
};

export default Order;
export const API_BASE = "https://geobites.onrender.com"

async function handleJSON(res) {
  const text = await res.text();
  try {
    return JSON.parse(text || "{}");
  } catch {
    return {};
  }
}

export async function signup({ name, email, password }) {
  const res = await fetch(`${API_BASE}/api/auth/signup`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ name, email, password }),
  });

  if (!res.ok) {
    const d = await handleJSON(res).catch(() => ({}));
    throw new Error(d.message || "Signup failed");
  }

  return handleJSON(res);
}

export async function login({ email, password }) {
  const res = await fetch(`${API_BASE}/api/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ email, password }),
  });

  if (!res.ok) {
    const d = await handleJSON(res).catch(() => ({}));
    throw new Error(d.message || "Login failed");
  }

  return handleJSON(res);
}

export async function logout() {
  try {
    await fetch(`${API_BASE}/api/auth/logout`, {
      method: "POST",
      credentials: "include",
    });
  } catch (e) {
    // ignore
  }
}

export async function getCurrentUser() {
  try {
    const res = await fetch(`${API_BASE}/api/auth/me`, {
      credentials: "include",
    });
    if (!res.ok) return null;

    const d = await handleJSON(res);
    if (d && d.authenticated)
      return { email: d.email, name: d.name, role: d.role };

    return null;
  } catch (e) {
    return null;
  }
}

export default { signup, login, logout, getCurrentUser };
export function cartKeyForEmail(email) {
  return `gb_cart_${email}`;
}

export function loadCart(email) {
  if (!email) return [];
  try {
    return JSON.parse(localStorage.getItem(cartKeyForEmail(email)) || "[]");
  } catch {
    return [];
  }
}

export function saveCart(email, cart) {
  if (!email) return;
  localStorage.setItem(cartKeyForEmail(email), JSON.stringify(cart));
}

export default { cartKeyForEmail, loadCart, saveCart };
.about {
  width: 100%;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-image: url('../assets/pic6.jpg'); 
  background-size: cover;
  background-position: center -10px;
  background-repeat: no-repeat;
  text-align: center;
  position: relative;
  color: white;
  padding: 0 20px;
}

/* Overlay for readability */
.about-overlay {
  background-color: rgba(0, 0, 0, 0.8);
  padding: 40px 60px;
  border-radius: 10px;
  max-width: 700px;
}

.about-overlay h1 {
  font-size: 2.5rem;
  margin-bottom: 20px;
  font-weight: 600;
}

.about-overlay p {
  font-size: 1.1rem;
  line-height: 1.6;
}

@media (max-width: 768px) {
  .about-overlay {
    padding: 30px 20px;
  }

  .about-overlay h1 {
    font-size: 1.8rem;
  }

  .about-overlay p {
    font-size: 1rem;
  }
}
.App{
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}
.page-content{
    flex: 1;
    padding-top:100px ;
    padding-bottom: 60px;
    background-color: white;
}
.auth-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.auth-modal {
  background: #fff;
  width: 90%;
  max-width: 400px;
  padding: 30px 40px;
  border-radius: 10px;
  position: relative;
  box-shadow: 0 4px 20px rgba(196, 37, 37, 0.3);
  text-align: center;
}

.close-btn {
  position: absolute;
  top: 10px;
  right: 14px;
  border: 0;
  background: transparent;
  font-size: 1.6rem;
  line-height: 1;
  cursor: pointer;
}

.tabs {
  display: flex;
  margin-bottom: 18px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #eee;
}
.tabs button.active{
  background-color: rgb(26,7,1);
  color: white;
}
.tabs button:hover{
  background-color: #c8b6ac;
}
.tabs button {
  flex: 1;
  padding: 10px;
  border: 0;
  background: #ddd0c8;
  cursor: pointer;
  font-weight: 600;
  transition: background .25s, color .25s;
}

.tabs .active {
  background:rgb(26, 7, 1);
  color: #fff;
}

form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

input {
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  text-align: center;
  font-size: 0.95rem;
  
}

.submit-btn {
  background:rgb(26, 7, 1);
  color: #fff;
  border: 0;
  padding: 10px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: background .25s;
}



.link-btn {
  background: transparent;
  border: 0;
  color: #555;
  text-decoration: underline;
  cursor: pointer;
}

.error {
  color: #c62828;
  font-size: .9rem;
  margin: 4px 0;
}


@media (max-width: 480px) {
  .auth-modal { padding: 24px; }
  .tabs button { padding: 8px; }
  input { font-size: 0.9rem; }
}
.checkout-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.checkout-modal {
  background: white;
  padding: 20px;
  width: 520px;
  max-width: 95%;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  position: relative;
}

.checkout-modal h2 { margin-top: 0; }
.checkout-summary { margin-bottom: 12px; }
.items-list { max-height: 160px; overflow:auto; margin-bottom: 8px; }
.item-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom: 1px solid #eee; }
.totals div { display:flex; justify-content:space-between; padding:4px 0; }
.total-row { font-size: 1.1rem; margin-top:6px; }
.checkout-form label { display:block; margin-top:8px; font-weight:600; }
.checkout-form input, .checkout-form textarea { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; }
.checkout-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
.checkout-actions .primary { background:#f57c00; color:white; border:none; padding:8px 14px; border-radius:6px; }
.checkout-actions .secondary { background:#eee; color:#111; border:none; padding:8px 12px; border-radius:6px; }
.close-btn { position:absolute; top:8px; right:8px; border:none; background:transparent; font-size:20px; cursor:pointer; }
.demo-note { font-size:0.85rem; color:#666; margin-top:8px; }

.contact{
    text-align: center;
    width: 100%;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background-image: url('../assets/pic4.jpg');
    background-size: cover;
    background-position: center -20px;
    background-repeat: no-repeat;
}
.form{
    background-color: rgba(255, 255, 255, 0.5);
    border: solid 1px black;
    border-radius: 10px;
    padding: 30px 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 50%;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
h1{
    font-size: 50px;
    font-family: 'Times New Roman', Times, serif;
}
input::placeholder,textarea::placeholder{
    text-align: center;
    color: #888;
}
input,textarea{
    width: 95%;
    margin: 8px 0;
    padding: 10px;
    border: 1px solid black;
    border-radius: 6px;
    text-align: center;
    resize: none;
}
button{
    margin-top: 15px;
    padding: 10px 20px;background-color:rgb(26, 7, 1);
    color: white;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
}
button:hover{
    background-color:rgb(60, 15, 2);
}
.sixthline{
    margin-top: 20px;
    text-align: center;
    color: black;
    font-weight: bold;
}
.form >div{
    width: 100%;
}
.secondline{
    display: flex;
    justify-content: space-between;
    width: 100%;
    gap: 10px;
    box-sizing: border-box;
}
.secondline input{
  width: calc(50%-5px);
}
@media(max-width:768px){
    .form{
        width: 70%;
    }
}
.footer {
  width: 100%;
  height: 100px;
  background-color: rgb(48, 47, 47);
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: fixed;
  bottom: 0;
  left: 0;
  box-sizing: border-box;
}

.socialMedia {
  display: flex;
  gap: 20px;
  margin-bottom: 8px;
}

.socialMedia svg {
  font-size: 28px;
  cursor: pointer;
  transition: color 0.3s, transform 0.2s;
}

.socialMedia svg:hover {
  color: #f57c00; /* your orange accent */
  transform: scale(1.2);
}

.footer p {
  font-size: 0.9rem;
  opacity: 0.8;
}
.home {
  width: 100%;
  min-height: 100vh;
}

.home-top {
  height: 80vh;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

.overlay {
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  padding: 60px;
  border-radius: 10px;
  text-align: center;
  max-width: 700px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.overlay h1 {
  font-size: 2.8rem;
  margin-bottom: 15px;
  letter-spacing: 1px;
}

.overlay p {
  font-size: 1.2rem;
  margin-bottom: 25px;
  line-height: 1.6;
  opacity: 0.95;
}

.btn {
  background-color: rgb(139, 0, 0);
  color: white;
  padding: 10px 20px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  transition: background-color 0.3s, transform 0.2s;
}

.btn:hover {
  background-color: rgb(255, 0, 0);
  transform: translateY(-2px);
}


.home-bottom {
  background: linear-gradient(to bottom, #ffffff, #f8f8f8);
  padding: 80px 20px;
  text-align: center;
  border-top: 2px solid rgba(0, 0, 0, 0.05);
  box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.03);
}

.home-bottom h2 {
  font-size: 2.2rem;
  color: rgb(26, 7, 1);
  margin-bottom: 25px;
  text-transform: uppercase;
  letter-spacing: 2px;
  position: relative;
}

.home-bottom h2::after {
  content: "";
  display: block;
  width: 80px;
  height: 4px;
  background: #f57c00;
  margin: 12px auto 0;
  border-radius: 2px;
}

.home-bottom p {
  font-size: 1.3rem;
  color: #333;
  max-width: 700px;
  margin: 30px auto 0;
  line-height: 1.7;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.home-bottom:hover h2 {
  color: #f57c00;
  transition: color 0.4s ease;
}


@media (max-width: 768px) {
  .overlay h1 {
    font-size: 1.6rem;
  }

  .overlay p {
    font-size: 1rem;
  }

  .home-top {
    height: 55vh;
    margin-top: 0;
    padding-top: 0;
  }

  .overlay {
    padding: 40px 25px;
  }

  .home-bottom {
    padding: 60px 15px;
  }

  .home-bottom h2 {
    font-size: 1.6rem;
  }

  .home-bottom p {
    font-size: 1.1rem;
  }
}
.inbox {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
}

.inbox h1 {
  text-align: center;
  margin-bottom: 20px;
  color: rgb(26, 7, 1);
}

.inbox-error {
  color: #b00020;
  font-weight: 600;
  text-align: center;
}

.inbox-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.inbox-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 14px 16px;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  transition: transform 0.2s ease;
}

.inbox-card:hover {
  transform: scale(1.01);
}


.delete-btn {
  position: absolute;
  top: 8px;
  right: 10px;
  border: none;
  background: transparent;
  color: #b00020;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s, color 0.2s;
}

.delete-btn:hover {
  color: red;
  transform: scale(1.2);
}


.inbox-top {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 0.95rem;
  color: #333;
}

.inbox-subject {
  font-weight: 700;
  margin-bottom: 6px;
  color: #222;
}

.inbox-body {
  white-space: pre-wrap;
  color: #444;
  line-height: 1.5;
}

@media (max-width: 768px) {
  .inbox-card {
    font-size: 0.9rem;
    padding: 12px;
  }

  .delete-btn {
    font-size: 18px;
  }

  .inbox-top {
    flex-direction: column;
    gap: 4px;
  }
}
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}

.menu-page {
    margin-top: 100px;
    padding: 20px;
    text-align: center;
}

.menu-title {
    margin-bottom: 16px;
}

.menu-slider {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 8px 0;
    justify-content: center;
}

.menu-category-btn {
    background:rgb(26, 7, 1);
    border: 0;
    padding: 10px 14px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
}

.menu-category-btn.active {
    background: #f57c00;
    color: #fff;
}

.menu-items {
    margin-top: 18px;
    display: grid;
    gap: 18px;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.menu-item-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px;
    transition: transform .2s, box-shadow .2s;
}

.menu-item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
}

.menu-item-card img {
    width: 100%;
    height: 600px;
    object-fit: cover;
    border-radius: 10px;
}

.menu-item-card h3 {
    margin: 10px 0 4px;
    font-size: 1.05rem;
}

.menu-item-card p {
    margin: 0 0 10px;
    font-weight: 600;
}

.menu-item-card button {
    background: #f57c00;
    color: #fff;
    border: 0;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
}

.menu-item-card button:hover {
    background: #e86b00;
}

.login-warning{
    color: #a00;
    font-size: 0.9rem;
    font-weight: 600;
    margin: 8px 0 0;
}

@media(max-width:768px){
    .menu-item-card img {
     height: 200px;
    
}
}
.navbar {
  width: 100%;
  height: 100px;
  position: fixed;
  top: 0px;
  left: 0;
  background-color: rgb(26, 7, 1);
  border: 1px solid black;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.user-greeting{
  color: white;
  font-size: 20px;
  font-weight: 500;
  margin-right: 15px;
}
.navlinks {
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  align-items: center;
  width: 100%;
  height: 100%;
}

.navlinks a {
  text-decoration: none;
  color: white;
  font-size: 25px;
  font-weight: 500;
  transition: color 0.3s, transform 0.2s;
}

.navlinks a:hover {
  color: #ffd700;
  transform: translateY(-2px);
}


.navlinks img {
  height: 95px;
  padding-top: 5px;
  padding-left: 5px;
  border-radius: 50%;
  object-fit: cover;
}

.authtoggleBtn {
  background-color: white;
  color: rgb(26, 7, 1);
  font-size: 17px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  transition: background-color 0.3s, color 0.3s, transform 0.2s;
  margin: 0px;
}

.authtoggleBtn:hover {
  background-color: #f57c00;
  color: white;
  transform: scale(1.05);
}


.cart-btn {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: white;
  border: 2px solid #f57c00;
  margin-left: 10px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.cart-btn:hover {
  background-color: #f57c00;
  transform: scale(1.05);
}

.cart-icon {
  color: #f57c00;
  font-size: 22px !important;
  transition: color 0.3s ease;
}

.cart-btn:hover .cart-icon {
  color: white;
}

@media (max-width: 768px) {
  .navlinks {
    flex-wrap: wrap;
    justify-content: center;
    padding: 10px;
  }

  .navlinks a {
    font-size: 10px;
    margin: 5px;
  }

  .authtoggleBtn {
    font-size: 15px;
    padding: 6px 12px;
  }

  .cart-btn {
    width: 20px;
    height: 20px;
  }
 
  .cart-badge{
    width: 10px;
    height: 10px;
  }
  .navlinks img {
    height: 50px;
  }
  .authtoggleBtn{
    width: 50px;
    font-size: 10px;
    padding: 5px;
  }
}

.order-background {
  background-image: url('../assets/pic1.JPG');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;

  min-height: 100vh;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 100px; 
}
.order-page {
    margin-top: 100px;
    padding: 30px 20px;
    max-width: 950px;
    margin-inline: auto;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
}

.order-title {
    text-align: center;
    color: #222;
    font-size: 2rem;
    margin-bottom: 20px;
}

.empty-cart {
    text-align: center;
    font-size: 1.1rem;
    color: #666;
    margin-top: 40px;

}


.cart-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 25px;
}

.cart-card {
    display: grid;
    grid-template-columns: 80px 1fr auto auto auto;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease;
}

.cart-card:hover {
    transform: scale(1.01);
}

.cart-card img {
    width: 80px;
    height: 70px;
    border-radius: 8px;
    object-fit: cover;
}

.cart-info h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.cart-info .price {
    color: #555;
    font-size: 0.9rem;
}

.cart-qty {
    display: flex;
    align-items: center;
    gap: 8px;
}

.cart-qty button {
    width: 28px;
    height: 28px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #f1f1f1;
    cursor: pointer;
    transition: background 0.3s;
}

.cart-qty button:hover {
    background-color: #f57c00;
    color: white;
}

.cart-qty span {
    font-weight: 600;
}

.line-total {
    font-weight: 700;
    color: #333;
}

.remove-btn {
    border: none;
    background: transparent;
    color: #d32f2f;
    font-size: 1.3rem;
    cursor: pointer;
    transition: transform 0.2s;
}

.remove-btn:hover {
    transform: scale(1.2);
}

/* Summary */
.order-summary {
    display: flex;
    justify-content: space-between;
    padding: 15px 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.summary-left p,
.summary-right p {
    margin: 5px 0;
    font-weight: 500;
}

.total-text {
    font-size: 1.1rem;
    font-weight: 700;
    color: #f57c00;
}

.checkout-btn {
    display: block;
    margin: 0 auto;
    padding: 12px 30px;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background-color: #f57c00;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.checkout-btn:hover {
    background-color: #e86b00;
}

@media (max-width: 768px) {
    .cart-card {
        grid-template-columns: 70px 1fr auto auto;
        font-size: 0.9rem;
    }

    .cart-card img {
        height: 60px;
    }

    .order-summary {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .checkout-btn {
        width: 100%;
    }
}
import { BrowserRouter as Router, Routes, Route } from "react-router-dom";
import Navbar from "./components/Navbar";
import Footer from "./components/Footer";
import Home from "./pages/Home";
import About from "./pages/About";
import Menu from "./pages/Menu";
import Order from "./pages/Order";
import Contact from "./pages/Contact";
import Inbox from "./pages/Inbox";
import "./styles/App.css";
import { useEffect, useState } from "react";
import { getCurrentUser, logout as authLogout, API_BASE } from "./services/authService";

function App() {
  const [cart, setCart] = useState([]);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [isOwner, setIsOwner] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    // Check server for current user session
    (async () => {
      const u = await getCurrentUser();
      if (u) {
        setCurrentUser(u);
        setIsLoggedIn(true);
        setIsOwner(u.role === "owner");

        // load server-side cart
        try {
          const r = await fetch(`${API_BASE}/api/cart`, {
            credentials: "include",
          });
          if (r.ok) {
            const cartData = await r.json();
            setCart(Array.isArray(cartData) ? cartData : []);
          }
        } catch (e) {
          // ignore
        }
      } else {
        setIsLoggedIn(false);
        setIsOwner(false);
        setCurrentUser(null);
      }
    })();
  }, []);

  // Persist cart for the current user (server-backed)
  useEffect(() => {
    if (currentUser && currentUser.email) {
      (async () => {
        try {
          await fetch(`${API_BASE}/api/cart`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cart),
          });
        } catch (e) {
          // ignore
        }
      })();
    }
  }, [cart, currentUser]);

  const addToCart = (item) => {
    setCart((prev) => {
      const idx = prev.findIndex((p) => p.id === item.id);
      if (idx === -1) return [...prev, { ...item, qty: 1 }];
      const copy = [...prev];
      copy[idx] = { ...copy[idx], qty: copy[idx].qty + 1 };
      return copy;
    });
  };

  const handleLoginSuccess = (user) => {
    setCurrentUser(user || null);
    setIsLoggedIn(true);
    setIsOwner(user?.role === "owner");

    // load cart for this user after login
    (async () => {
      try {
        const r = await fetch(`${API_BASE}/api/cart`, {
          credentials: "include",
        });
        if (r.ok) {
          const cartData = await r.json();
          setCart(Array.isArray(cartData) ? cartData : []);
        }
      } catch (e) {
        // ignore
      }
    })();
  };

  const handleLogout = async () => {
    try {
      await authLogout();
    } catch (e) {
      // ignore
    }
    setCurrentUser(null);
    setIsLoggedIn(false);
    setIsOwner(false);
    setCart([]);
  };

  const incQty = (id) =>
    setCart((prev) =>
      prev.map((it) => (it.id === id ? { ...it, qty: it.qty + 1 } : it))
    );

  const decQty = (id) =>
    setCart((prev) =>
      prev
        .map((it) =>
          it.id === id ? { ...it, qty: Math.max(1, it.qty - 1) } : it
        )
        .filter((it) => it.qty > 0)
    );

  const removeItem = (id) =>
    setCart((prev) => prev.filter((it) => it.id !== id));

  const clearCart = async () => {
    try {
      await fetch(`${API_BASE}/api/cart`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify([]),
      });
    } catch (e) {
      // ignore
    }
    setCart([]);
  };

  return (
    <Router>
      <div className="App">
        <Navbar
          cartCount={cart.reduce((sum, it) => sum + it.qty, 0)}
          isLoggedIn={isLoggedIn}
          setIsLoggedIn={setIsLoggedIn}
          isOwner={isOwner}
          setIsOwner={setIsOwner}
          onLoginSuccess={handleLoginSuccess}
          onLogout={handleLogout}
          currentUser={currentUser}
        />

        <div className="page-content">
          <Routes>
            <Route path="/" element={<Home />} />
            <Route path="/about" element={<About />} />
            <Route
              path="/menu"
              element={<Menu onAddToCart={addToCart} isLoggedIn={isLoggedIn} />}
            />
            <Route
              path="/order"
              element={
                <Order
                  cart={cart}
                  incQty={incQty}
                  decQty={decQty}
                  removeItem={removeItem}
                  currentUser={currentUser}
                  onClearCart={clearCart}
                />
              }
            />
            <Route path="/contact" element={<Contact />} />
            <Route path="/inbox" element={<Inbox />} />
          </Routes>
        </div>

        <Footer />
      </div>
    </Router>
  );
}

export default App;

--------------------------------------------------
carts.json:
{
  "owner@geobites.com": []
}

contact.json:
[]

contacts.json:
[
  {
    "id":"9je275ml42wmhtkg70m",
    "name": "georges",
    "subject": "vui",
    "email": "42230938@students.liu.edu.lb",
    "description": "ssadsads",
    "createdAt": "2025-11-10T19:59:36.838Z"
  },
  {
    "id":"h0labme4o0kmhtlko7i",
    "name": "sdsf",
    "subject": "sfsdfds",
    "email": "sadsadsad@gmail.com",
    "description": "asdasdas",
    "createdAt": "2025-11-10T20:31:05.358Z"
  }
]

orders.json:
[]

users.json:
[
  {
    "email": "42230938@students.liu.edu.lb",
    "name": "georges",
    "passwordHash": "$2b$10$N9Y160SSMNloBXPWKJklyOlSKZpEV/F0ykYMRi1epbMUxpV0ha0me"
  }
]

.env:
PORT=4000
JWT_SECRET=change_this_to_a_long_random_secret
OWNER_EMAIL=owner@geobites.com
OWNER_PASSWORD=Owner@123
CORS_ORIGIN=http://localhost:3000
NODE_ENV=development

server.js:
// server/server.js
require("dotenv").config();

const express = require("express");
const cors = require("cors");
const cookieParser = require("cookie-parser");
const jwt = require("jsonwebtoken");
const bcrypt = require("bcryptjs");
const path = require("path");
const fs = require("fs").promises;
const { randomUUID } = require("crypto");

const app = express();

/* ============ Config ============ */
const PORT = Number(process.env.PORT) || 4000;
const JWT_SECRET = process.env.JWT_SECRET || "change_me_dev_secret";
const OWNER_EMAIL = process.env.OWNER_EMAIL || "owner@geobites.com";
const OWNER_PASSWORD = process.env.OWNER_PASSWORD || "Owner@123";
const CORS_ORIGIN =
  process.env.CORS_ORIGIN || "http://localhost:3000";

const IS_PROD = process.env.NODE_ENV === "production";

const COOKIE_BASE = {
  httpOnly: true,
  sameSite: IS_PROD ? "none" : "lax",
  secure: IS_PROD,
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days
};

/* ============ File storage paths ============ */
const DATA_DIR = path.join(__dirname, "data");
const CONTACTS_PATH = path.join(DATA_DIR, "contact.json");
const USERS_PATH = path.join(DATA_DIR, "users.json");
const CARTS_PATH = path.join(DATA_DIR, "carts.json");
const ORDERS_PATH = path.join(DATA_DIR, "orders.json");

/* ============ Store utils ============ */
async function ensureStore() {
  await fs.mkdir(DATA_DIR, { recursive: true });

  async function ensureFile(filePath, fallback) {
    try {
      await fs.access(filePath);
    } catch {
      await fs.writeFile(filePath, fallback, "utf8");
    }
  }

  await ensureFile(CONTACTS_PATH, "[]");
  await ensureFile(USERS_PATH, "[]");
  await ensureFile(CARTS_PATH, "{}");
  await ensureFile(ORDERS_PATH, "[]");
}

/* ---- Contacts ---- */
async function readContacts() {
  try {
    const raw = await fs.readFile(CONTACTS_PATH, "utf8");
    return JSON.parse(raw || "[]");
  } catch {
    return [];
  }
}

async function writeContacts(list) {
  await fs.writeFile(CONTACTS_PATH, JSON.stringify(list, null, 2), "utf8");
}

/* ---- Users ---- */
async function readUsers() {
  try {
    const raw = await fs.readFile(USERS_PATH, "utf8");
    return JSON.parse(raw || "[]");
  } catch {
    return [];
  }
}

async function writeUsers(list) {
  await fs.writeFile(USERS_PATH, JSON.stringify(list, null, 2), "utf8");
}

/* ---- Carts ---- */
async function readCarts() {
  try {
    const raw = await fs.readFile(CARTS_PATH, "utf8");
    return JSON.parse(raw || "{}");
  } catch {
    return {};
  }
}

async function writeCarts(obj) {
  await fs.writeFile(CARTS_PATH, JSON.stringify(obj, null, 2), "utf8");
}

/* ---- Orders ---- */
async function readOrders() {
  try {
    const raw = await fs.readFile(ORDERS_PATH, "utf8");
    return JSON.parse(raw || "[]");
  } catch {
    return [];
  }
}

async function writeOrders(list) {
  await fs.writeFile(ORDERS_PATH, JSON.stringify(list, null, 2), "utf8");
}

/* ============ Auth helpers ============ */
function requireAuth(req, res, next) {
  const token = req.cookies?.token;
  if (!token) return res.status(401).json({ message: "Unauthorized" });

  try {
    const payload = jwt.verify(token, JWT_SECRET);
    req.user = payload;
    next();
  } catch {
    return res.status(401).json({ message: "Unauthorized" });
  }
}

function requireOwner(req, res, next) {
  const token = req.cookies?.token;
  if (!token) return res.status(401).json({ message: "Unauthorized" });

  try {
    const payload = jwt.verify(token, JWT_SECRET);
    if (payload.role !== "owner") {
      return res.status(401).json({ message: "Unauthorized" });
    }
    req.user = payload;
    next();
  } catch {
    return res.status(401).json({ message: "Unauthorized" });
  }
}

/* ============ Middleware ============ */
app.use(express.json());
app.use(cookieParser());

const corsOptions = {
  origin: CORS_ORIGIN,
  credentials: true,
  methods: ["GET", "POST", "DELETE", "OPTIONS"],
  allowedHeaders: ["Content-Type", "Authorization"],
};
app.use(cors(corsOptions));

app.use((req, _res, next) => {
  console.log(`${req.method} ${req.path}`, {
    origin: req.headers.origin,
    hasCookie: !!req.cookies?.token,
  });
  next();
});

/* ============ Health ============ */
app.get("/health", (_req, res) => res.json({ ok: true }));

/* ============ Auth routes ============ */
app.post("/api/auth/login", async (req, res) => {
  const { email, password } = req.body || {};
  if (typeof email !== "string" || typeof password !== "string") {
    return res.status(400).json({ message: "Invalid payload" });
  }

  // Owner login
  if (email === OWNER_EMAIL && password === OWNER_PASSWORD) {
    const token = jwt.sign(
      { role: "owner", email },
      JWT_SECRET,
      { expiresIn: "7d" }
    );

    res.cookie("token", token, COOKIE_BASE);

    return res.json({
      ok: true,
      role: "owner",
      email,
      token,
    });
  }

  // Normal user login
  try {
    const users = await readUsers();
    const u = users.find((x) => x.email === email);
    if (!u) return res.status(401).json({ message: "Invalid credentials" });

    const ok = bcrypt.compareSync(password, u.passwordHash || "");
    if (!ok) return res.status(401).json({ message: "Invalid credentials" });

    const token = jwt.sign(
      { role: "user", email: u.email, name: u.name },
      JWT_SECRET,
      { expiresIn: "7d" }
    );

    res.cookie("token", token, COOKIE_BASE);

    return res.json({
      ok: true,
      role: "user",
      email: u.email,
      name: u.name,
      token,
    });
  } catch (e) {
    console.error("login error", e);
    return res.status(500).json({ message: "Server error" });
  }
});

app.post("/api/auth/signup", async (req, res) => {
  const { name = "", email = "", password = "" } = req.body || {};
  if (!email || !password || !name) {
    return res.status(400).json({ message: "Missing fields" });
  }

  try {
    const users = await readUsers();
    if (users.find((u) => u.email === email)) {
      return res.status(400).json({ message: "User exists" });
    }

    const passwordHash = bcrypt.hashSync(password, 10);
    const user = { email, name, passwordHash };
    users.push(user);
    await writeUsers(users);

    const token = jwt.sign(
      { role: "user", email: user.email, name: user.name },
      JWT_SECRET,
      { expiresIn: "7d" }
    );

    res.cookie("token", token, COOKIE_BASE);

    res.json({
      ok: true,
      role: "user",
      email: user.email,
      name: user.name,
      token,
    });
  } catch (e) {
    console.error("signup error", e);
    res.status(500).json({ message: "Failed to create user" });
  }
});

app.post("/api/auth/logout", (_req, res) => {
  res.clearCookie("token", {
    httpOnly: true,
    sameSite: COOKIE_BASE.sameSite,
    secure: COOKIE_BASE.secure,
  });
  res.json({ ok: true });
});

app.get("/api/auth/me", (req, res) => {
  const token = req.cookies?.token;
  if (!token) return res.json({ authenticated: false });

  try {
    const payload = jwt.verify(token, JWT_SECRET);
    return res.json({
      authenticated: true,
      role: payload.role,
      email: payload.email,
      name: payload.name,
    });
  } catch {
    return res.json({ authenticated: false });
  }
});

/* ============ Contact routes ============ */
app.post("/api/contact", async (req, res) => {
  const {
    name = "",
    subject = "",
    email = "",
    description = "",
  } = req.body || {};

  const entry = {
    id: randomUUID(),
    name: String(name).trim(),
    subject: String(subject).trim(),
    email: String(email).trim(),
    description: String(description).trim(),
    createdAt: new Date().toISOString(),
  };

  if (
    !entry.name &&
    !entry.email &&
    !entry.subject &&
    !entry.description
  ) {
    return res.status(400).json({ message: "Empty message" });
  }

  try {
    const list = await readContacts();
    list.push(entry);
    await writeContacts(list);
    res.json({ ok: true });
  } catch {
    res.status(500).json({ message: "Failed to save message" });
  }
});

app.get("/api/contact", requireOwner, async (_req, res) => {
  try {
    const list = await readContacts();
    list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    res.json(list);
  } catch {
    res.status(500).json({ message: "Failed to read messages" });
  }
});

app.delete("/api/contact/:id", requireOwner, async (req, res) => {
  const id = String(req.params.id || "").trim();
  console.log("DELETE /api/contact", { id });

  try {
    const list = await readContacts();
    const next = list.filter((m) => String(m.id).trim() !== id);
    if (next.length === list.length) {
      return res.status(404).json({ message: "Message not found" });
    }
    await writeContacts(next);
    res.json({ ok: true });
  } catch (e) {
    console.error("Delete error", e);
    res.status(500).json({ message: "Failed to delete" });
  }
});

/* ============ Cart routes ============ */
app.get("/api/cart", requireAuth, async (req, res) => {
  try {
    const carts = await readCarts();
    const cart = carts[req.user.email] || [];
    res.json(cart);
  } catch {
    res.status(500).json({ message: "Failed to read cart" });
  }
});

app.post("/api/cart", requireAuth, async (req, res) => {
  try {
    const carts = await readCarts();
    const newCart = Array.isArray(req.body) ? req.body : [];
    carts[req.user.email] = newCart;
    await writeCarts(carts);
    res.json({ ok: true });
  } catch (e) {
    console.error("save cart error", e);
    res.status(500).json({ message: "Failed to save cart" });
  }
});

/* ============ Orders routes ============ */
app.post("/api/orders", requireAuth, async (req, res) => {
  try {
    const {
      name = "",
      address = "",
      items = [],
      subtotal = 0,
      fee = 0,
      total = 0,
    } = req.body || {};

    if (!name || !address || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({ message: "Missing order fields" });
    }

    const orders = await readOrders();
    const order = {
      id: randomUUID(),
      email: req.user.email,
      name,
      address,
      items,
      subtotal,
      fee,
      total,
      createdAt: new Date().toISOString(),
    };
    orders.push(order);
    await writeOrders(orders);
    res.json({ ok: true, orderId: order.id });
  } catch (e) {
    console.error("save order error", e);
    res.status(500).json({ message: "Failed to save order" });
  }
});

app.get("/api/orders", requireOwner, async (_req, res) => {
  try {
    const orders = await readOrders();
    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    res.json(orders);
  } catch {
    res.status(500).json({ message: "Failed to read orders" });
  }
});

/* ============ Serve React build ============ */
const clientBuildPath = path.join(__dirname, "..", "build");
app.use(express.static(clientBuildPath));

app.use((req, res, next) => {
  // Let API routes 404 normally
  if (req.path.startsWith("/api")) return next();

  res.sendFile(path.join(clientBuildPath, "index.html"), (err) => {
    if (err) return next(err);
  });
});

/* ============ Start ============ */
(async () => {
  await ensureStore();
  console.log("CONTACTS_PATH:", CONTACTS_PATH);
  app.listen(PORT, () => {
    console.log(`API running on http://localhost:${PORT}`);
  });
})();